'use strict'

var EventEmitter = require('events').EventEmitter;

function clients(){

  var _clients = {};

  var event = new EventEmitter();

  var add = function(client){
    _clients[client.key] = client;
    console.log('add new client');
    console.log('clients: ', Object.keys(_clients));
    event.emit('clients add', client);
  }

  var remove = function(key){
    event.emit('clients prepare remove', _clients[key]);
    delete _clients[key];
    console.log('remove client: '+key);
    console.log('clients: ', Object.keys(_clients));
    event.emit('clients remove', key);
  }

  var findOne = function(condition){
    var keys = Object.keys(_clients);

    if (typeof condition !== 'undefined'){
      if (typeof condition.key !== 'undefined'){
        keys = [condition.key];
      }
    }

    if (keys.length === 0){
      return undefined;
    } else {
      return _clients[keys[0]];
    }

  }

  //возвращает массив с доступными пользовтелями
  var list = function(condition){
    var keys = Object.keys(_clients);

      if (typeof condition !== 'undefined'){
           if (typeof condition.exclude !== 'undefined'){
        keys.splice(keys.indexOf(condition.exclude), 1);
      }
      if (typeof condition.attribute !== 'undefined'){
        var key = Object.keys(condition.attribute)[0];
        var value = condition.attribute[key];
        keys = [];
        for (var k in _clients){
          if (_clients[k].hasOwnProperty(key) && _clients[k][key] === value){
            keys.push(k);
          }
        }
      }
    }

    return keys;
  }

  return {
    add: add,
    remove: remove,
    list: list,
    findOne: findOne,
    event:event
  }
}

module.exports = clients;
